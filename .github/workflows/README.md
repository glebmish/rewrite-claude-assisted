# Rewrite-Assist Workflow Artifacts

This document describes all artifacts generated by the `rewrite-assist.yml` workflow.

## GitHub Workflow Artifacts

The workflow uploads two artifact bundles (see lines 83-99 in `rewrite-assist.yml`):

### 1. `{artifact_prefix}-claude-logs`
- **Content**: Claude Code JSONL log files
- **Source**: `${{steps.run_claude_code_workflow.outputs.claude_logs}}`
- **Purpose**: Complete conversation log for debugging and analysis

### 2. `{artifact_prefix}-run-metadata`
- **Content**: Complete scratchpad directory with all generated files
- **Source**: `${{steps.run_claude_code_workflow.outputs.scratchpad_dir}}`
- **Path**: `.scratchpad/<yyyy-mm-dd-hh-MM>/`
- **Purpose**: All workflow execution artifacts and analysis results

## Artifact Contents

All files below are contained within the scratchpad directory uploaded as `run-metadata`:

### Core Execution Logs

| File | Generator | Description |
|------|-----------|-------------|
| `rewrite-assist-scratchpad.md` | rewrite-assist command | Main execution log tracking all phases, commands, results, and progress |
| `workflow-metadata.json` | entrypoint.sh:162-172 | Execution metadata: `pr_url`, `status`, `exit_code`, `duration_seconds`, `start_time`, `end_time` |

### Session Analysis Artifacts

Generated by `eval/analyze-workflow.sh`:

| File | Generator Script | Description |
|------|-----------------|-------------|
| `claude-log.jsonl` | scripts/fetch-session.sh | Claude Code session log retrieved from API |
| `claude-usage-stats.json` | scripts/analysis/claude-stats.py | Tool usage metrics: `total_messages`, `tool_calls`, success rates, tool breakdown |
| `claude-cost-stats.json` | scripts/analysis/claude-stats.py | API cost analysis: token usage and costs by model (Sonnet/Haiku) |
| `recipe-precision-stats.json` | scripts/analysis/recipe-diff-precision.sh | Recipe effectiveness: `unnecessary_changes`, `missing_changes`, `precision`, `recall`, `f1_score`, `accuracy` |
| `evaluation-report.md` | /analyze-session command | Qualitative workflow analysis report with detailed findings |
| `subjective-evaluation.json` | session-evaluator agent | Structured evaluation scores: `truthfulness`, `extractionQuality`, `mappingEffectiveness`, `validationCorrectness`, `overall` |

### Final Results Directory

Located in `result/` subdirectory (per `.claude/commands/rewrite-assist.md:30-35`):

| File | Description |
|------|-------------|
| `pr.diff` | Original PR diff (ground truth) |
| `recommended-recipe.yaml` | Final recommended OpenRewrite recipe |
| `recommended-recipe.diff` | Diff of recipe applied to main branch |

## Success Criteria

A successful workflow run produces:

### Required Files
- ✅ `rewrite-assist-scratchpad.md`
- ✅ `workflow-metadata.json`
- ✅ `result/pr.diff`
- ✅ `result/recommended-recipe.yaml`
- ✅ `result/recommended-recipe.diff`

### Analysis Files (post-execution)
- ✅ `claude-log.jsonl`
- ✅ `claude-usage-stats.json`
- ✅ `claude-cost-stats.json`
- ✅ `recipe-precision-stats.json`
- ✅ `evaluation-report.md`
- ✅ `subjective-evaluation.json`

---

# Suite Aggregation Workflows

Suite aggregation workflows (`*-suite-aggregate.yml`) collect and analyze results from multiple rewrite-assist batch runs to provide suite-wide metrics and comparisons.

## Input Requirements

The aggregation workflow expects artifacts from multiple rewrite-assist runs:

### Required Artifact from Each Run

**`{artifact_prefix}-run-metadata`** containing:

| File | Required | Purpose |
|------|----------|---------|
| `workflow-metadata.json` | **Yes** | Identifies PR, execution status, duration, exit code |
| `claude-cost-stats.json` | **Yes** | Provides cost data for aggregation |
| `claude-usage-stats.json` | **Yes** | Tool usage metrics for analysis |
| `subjective-evaluation.json` | Optional | Quality scores: truthfulness, extraction, mapping, validation, overall |
| `recipe-precision-stats.json` | Optional | Recipe precision metrics: accuracy, F1, unnecessary/missing changes |

### File Format Requirements

#### `workflow-metadata.json`
```json
{
  "pr_url": "https://github.com/owner/repo/pull/123",
  "status": "success" | "failed" | "timeout",
  "exit_code": 0,
  "duration_seconds": 1234,
  "start_time": "2025-10-25T12:00:00Z",
  "end_time": "2025-10-25T12:20:34Z"
}
```

#### `claude-cost-stats.json`
```json
{
  "totals": {
    "costs": {
      "total_cost": 1.234
    }
  }
}
```

#### `claude-usage-stats.json`
```json
{
  "metrics": {
    "total_messages": 150,
    "tool_calls": 75,
    "successful_tool_calls": 70,
    "tool_success_rate": 0.933
  }
}
```

#### `subjective-evaluation.json`
```json
{
  "detailed_metrics": {
    "truthfulness": "95%",
    "intent_extraction_quality": "90%",
    "recipe_mapping_effectiveness": "85%",
    "validation_correctness": "90%"
  },
  "scores": {
    "overall_session_effectiveness": "88%"
  }
}
```

#### `recipe-precision-stats.json`
```json
{
  "metrics": {
    "unnecessary_changes": 5,
    "missing_changes": 3,
    "total_divergence": 8,
    "accuracy": 0.9523,
    "f1_score": 0.9412,
    "is_perfect_match": false
  }
}
```

## Suite Metrics Explained

### Success Rate
Percentage of runs that completed successfully (exit_code=0)

### Precision Metrics
- **Unnecessary Changes**: Recipe made changes not in original PR (false positives)
- **Missing Changes**: PR has changes recipe didn't make (false negatives)
- **Accuracy**: Overall match quality (inverse of divergence rate)
- **F1 Score**: Harmonic mean of precision and recall
- **Perfect Match**: Boolean indicating zero divergence

### Quality Scores
- **Truthfulness**: Execution accuracy and scratchpad correctness
- **Extraction Quality**: Intent tree accuracy vs PR changes
- **Mapping Effectiveness**: Recipe selection appropriateness
- **Validation Correctness**: Validation metrics match claims
- **Overall**: Combined session effectiveness score

---

# Data Ingestion Pipeline Workflow

The `data-ingestion.yml` workflow automates the OpenRewrite recipe database ingestion pipeline in GitHub Actions. For detailed information about the pipeline stages and local execution, see [data-ingestion/README.md](../../data-ingestion/README.md).

## Quick Start

**Trigger manually:**
```bash
gh workflow run data-ingestion.yml
```

**Trigger on schedule:** Uncomment the `schedule` section in the workflow.

## Required Secret: DOCKERHUB_TOKEN

To push images to DockerHub:

1. Generate token at [DockerHub Security Settings](https://hub.docker.com/settings/security)
   - Permissions: **Read, Write, Delete**
2. Add to repository: **Settings** → **Secrets and variables** → **Actions**
   - Name: `DOCKERHUB_TOKEN`
   - Value: Your token

## Workflow Behavior

- **Checks out:** `main` branch
- **Runs:** Execute ingestion pipeline
- **Produces:** `bboygleb/openrewrite-recipes-db:latest` and date-tagged images
- **Uploads:** Pipeline logs as artifacts on failure

## Image Usage

```bash
docker pull bboygleb/openrewrite-recipes-db:latest
docker run -d -p 5432:5432 bboygleb/openrewrite-recipes-db:latest
```

See [data-ingestion/README.md](../../data-ingestion/README.md) for complete pipeline documentation.
