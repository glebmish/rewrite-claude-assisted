name: 'Java Upgrades Eval'

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  actions: read

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    name: 'Generate Execution Matrix'
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      pr_summary: ${{ steps.matrix.outputs.pr_summary }}
    
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Generate matrix from PR configurations'
        id: matrix
        run: |
          # ==========================================
          # PR CONFIGURATION
          # ==========================================
          # Add PRs to evaluate here in the format: "PR_URL|NUMBER_OF_RUNS"
          # Each PR will be tested the specified number of times
          
          PR_CONFIGS=(
            "https://github.com/openrewrite-assist-testing-dataset/analytics-dashboard/pull/1|1"
            "https://github.com/openrewrite-assist-testing-dataset/notification-service/pull/1|1"
            "https://github.com/openrewrite-assist-testing-dataset/payment-processing-service/pull/1|1"
          )
          
          # ==========================================
          # END CONFIGURATION
          # ==========================================
          
          eval/generate-matrix.sh "${PR_CONFIGS[@]}"

  rewrite-assist-runs:
    needs: generate-matrix
    name: 'PR ${{ matrix.pr_num }} Run ${{ matrix.run }}/${{ matrix.total_runs }}'
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: false
    uses: ./.github/workflows/rewrite-assist.yml
    with:
      pr_url: ${{ matrix.pr_url }}
      strict_mode: false
    secrets: inherit

  analyze-results:
    needs: [generate-matrix, rewrite-assist-runs]
    runs-on: ubuntu-latest
    name: 'Analyze Suite Results'
    if: always()
    
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Download all artifacts'
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: 'run-metadata-*'

      - name: 'Analyze and generate suite summary'
        run: |
          eval/analyze-suite-results.sh "artifacts/"
      
      - name: 'Upload suite results'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: java-upgrades-eval-final-results
          path: suite-results/
          if-no-files-found: ignore
