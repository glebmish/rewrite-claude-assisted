name: 'Simple Suite Eval'

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  actions: read

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    name: 'Generate Execution Matrix'
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      pr_summary: ${{ steps.matrix.outputs.pr_summary }}
    
    steps:
      - name: 'Generate matrix from hardcoded PR configurations'
        id: matrix
        run: |
          # Hardcoded PR configurations with individual retry counts
          # Format: pr_url|runs
          pr_configs=(
            "https://github.com/glebmish/vintage-api/pull/4|1"
          )
          
          # Build matrix
          matrix_items=""
          pr_summary=""
          
          # for config in "${pr_configs[@]}"; do
          #   IFS='|' read -ra parts <<< "$config"
          #   pr_url="${parts[0]}"
          #   runs="${parts[1]}"
          #   pr_num=$(echo "$pr_url" | sed 's/.*\/pull\///g')
            
          #   # Add to summary
          #   if [ -n "$pr_summary" ]; then
          #     pr_summary="$pr_summary|"
          #   fi
          #   pr_summary="$pr_summary$pr_url:$pr_num:$runs"
            
          #   # Generate matrix entries for each run
          #   for run in $(seq 1 $runs); do
          #     if [ -n "$matrix_items" ]; then
          #       matrix_items="$matrix_items,"
          #     fi
          #     matrix_items="$matrix_items{\"pr_url\":\"$pr_url\",\"pr_num\":\"$pr_num\",\"run\":$run,\"total_runs\":$runs}"
          #   done
          # done
          
          matrix="{\"include\":[{\"pr_url\":\"https://github.com/glebmish/vintage-api/pull/4\",\"pr_num\":\"4\",\"run\":1,\"total_runs\":1}]}"
          
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "matrix=$matrix"
          echo "pr_summary=$pr_summary" >> $GITHUB_OUTPUT
          echo "pr_summary=$pr_summary"
          
          echo "Generated matrix for ${#pr_configs[@]} PR configurations"

  rewrite-assist-runs:
    needs: generate-matrix
    name: 'PR ${{ matrix.pr_num }} Run ${{ matrix.run }}/${{ matrix.total_runs }}'
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: false
    uses: ./.github/workflows/rewrite-assist.yml
    with:
      pr_url: ${{ matrix.pr_url }}
      strict_mode: ${{ true }}
    secrets: inherit

  analyze-results:
    needs: [generate-matrix, rewrite-assist-runs]
    runs-on: ubuntu-latest
    name: 'Analyze Suite Results'
    if: always()
    
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Download all artifacts'
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: '*-*'

      - name: 'Analyze and generate suite summary'
        run: |
          chmod +x eval/analysis/analyze-suite-results.sh
          eval/analysis/analyze-suite-results.sh
      
      - name: 'Upload suite results'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: simple-suite-eval-final-results
          path: suite-results/
          if-no-files-found: ignore
