---
type: specs.openrewrite.org/v1beta/recipe
name: com.yourorg.MigrateH2ToPostgreSQL.Consolidated
displayName: Migrate from H2 to PostgreSQL with Infrastructure Upgrades (Consolidated)
description: >
  Complete migration from H2 in-memory database to PostgreSQL production database.
  This consolidated version groups related transformations using regex patterns
  and broader file matchers where appropriate, reducing configuration verbosity
  while maintaining semantic transformation precision.

recipeList:
  # ============================================================================
  # Database Driver Migration: Gradle Dependencies
  # ============================================================================

  # Remove H2 and add PostgreSQL driver in one conceptual group
  - org.openrewrite.gradle.RemoveDependency:
      groupId: com.h2database
      artifactId: h2

  - org.openrewrite.gradle.AddDependency:
      groupId: org.postgresql
      artifactId: postgresql
      version: 42.6.0
      configuration: implementation
      onlyIfUsing: com.h2database..*

  # Add all Testcontainers dependencies for PostgreSQL testing
  - org.openrewrite.gradle.AddDependency:
      groupId: org.testcontainers
      artifactId: testcontainers
      version: 1.17.6
      configuration: testImplementation

  - org.openrewrite.gradle.AddDependency:
      groupId: org.testcontainers
      artifactId: postgresql
      version: 1.17.6
      configuration: testImplementation

  - org.openrewrite.gradle.AddDependency:
      groupId: org.testcontainers
      artifactId: junit-jupiter
      version: 1.17.6
      configuration: testImplementation

  # ============================================================================
  # Database Configuration: YAML Property Updates
  # ============================================================================

  # Update core database connection properties
  - org.openrewrite.yaml.ChangePropertyValue:
      propertyKey: database.driverClass
      newValue: org.postgresql.Driver
      oldValue: org.h2.Driver
      fileMatcher: '**/config.yml'

  - org.openrewrite.yaml.ChangePropertyValue:
      propertyKey: database.properties.hibernate.dialect
      newValue: org.hibernate.dialect.PostgreSQLDialect
      oldValue: org.hibernate.dialect.H2Dialect
      fileMatcher: '**/config.yml'

  # Externalize database credentials to environment variables
  - org.openrewrite.yaml.ChangePropertyValue:
      propertyKey: database.user
      newValue: '"{{ GET_ENV_VAR:DATABASE_USER }}"'
      oldValue: sa
      fileMatcher: '**/config.yml'

  - org.openrewrite.yaml.ChangePropertyValue:
      propertyKey: database.password
      newValue: '"{{ GET_ENV_VAR:DATABASE_PASSWORD }}"'
      fileMatcher: '**/config.yml'

  - org.openrewrite.yaml.ChangePropertyValue:
      propertyKey: database.url
      newValue: '"{{ GET_ENV_VAR:DATABASE_URL }}"'
      fileMatcher: '**/config.yml'

  # ============================================================================
  # Infrastructure Modernization
  # ============================================================================

  # GitHub Actions: Upgrade cache action to latest version
  - org.openrewrite.github.ChangeActionVersion:
      action: actions/cache
      version: v4

  # Docker: Modernize base image to Eclipse Temurin with Alpine
  - org.openrewrite.text.FindAndReplace:
      find: 'FROM openjdk:17-jre-slim'
      replace: 'FROM eclipse-temurin:17-jre-alpine'
      regex: false
      caseSensitive: true
      filePattern: 'Dockerfile'

  # ============================================================================
  # SQL Schema Migration: H2 to PostgreSQL Syntax
  # ============================================================================

  # Convert H2-specific auto-increment syntax to PostgreSQL BIGSERIAL
  # Targets all Flyway/Liquibase migration files with pattern V*__*.sql
  - org.openrewrite.text.FindAndReplace:
      find: 'BIGINT AUTO_INCREMENT'
      replace: 'BIGSERIAL'
      regex: false
      caseSensitive: true
      filePattern: '**/db/migration/V*__*.sql'

---
# Recipe Metadata
# Author: OpenRewrite Recipe Assistant
# Generated: 2025-11-16
# Session ID: a0288115-2a67-4c55-b32e-dd2fd2f7a2b6
#
# Differences from Option 1 (Granular):
# - Same 13 recipes but organized by logical grouping
# - Added conceptual comments to explain purpose of each group
# - Same semantic precision but more narrative structure
# - Easier to understand migration strategy at a glance
#
# Recipe Statistics:
# - Total transformations: 13
# - Semantic (LST-based): 11 (85%)
# - Text-based: 2 (15%)
#
# Coverage:
# - Database driver swap: 2 recipes (remove H2, add PostgreSQL)
# - Testing infrastructure: 3 recipes (Testcontainers suite)
# - Configuration updates: 5 recipes (driver, dialect, credentials)
# - GitHub Actions: 1 recipe (cache action upgrade)
# - Dockerfile: 1 recipe (base image modernization)
# - SQL syntax: 1 recipe (AUTO_INCREMENT â†’ BIGSERIAL)
#
# Why This Approach Works:
# - All transformations use semantic understanding where LST parsers exist
# - Text-based recipes only for SQL and Dockerfiles (no LST parsers available)
# - Grouping by purpose rather than file type improves readability
# - No loss of precision compared to granular approach
# - Maintains full coverage of all PR changes
