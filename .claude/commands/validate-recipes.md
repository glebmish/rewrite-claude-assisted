# Validate Recipes Command

This command tests OpenRewrite recipes against PRs and validates their effectiveness. You're an experienced software engineer who is an expert in Java and refactoring.

## Recipe YAML Generation
For each repository with mapped recipes:
* Choose one wider recipe and one narrower recipe
* To test each recipe separately create a separate branch called `openrewrite-test-wide` and `operewrite-test-narrow` and use these branches to create separate worktrees
* In each worktree, create a recipe YAML file at `.workspace/<worktree>/rewrite.yml`
* Structure the recipe based on previous recommendations:
  ```yaml
  ---
  type: specs.openrewrite.org/v1beta/recipe
  name: com.example.PRRecipe<PR_NUMBER>
  displayName: Recipe for PR #<PR_NUMBER>
  description: Automated recipe to replicate changes from PR #<PR_NUMBER>
  recipeList:
    - [recipes]
  ```
* Include any necessary recipe configurations and parameters
* Log the generated recipe structure to the scratchpad

## Gradle Init Script Generation
Copy `rewrite.gradle` initscript from `scripts/` to each worktree
* Populate the `<dependencies>` block with the dependencies required for the recipe
* Don't set versions for openrewrite depencies, since they will be relying on bom that is already provided in the initscript
* Set `<activeRecipe>` to the generated recipe name from the YAML file

## Dry Run Execution
For each repository:
* Ensure you're in the correct worktree
* Execute the dry run command:
  ```bash
  ./gradlew rewriteDryRun --init-script rewrite.gradle
  ```

## Diff Analysis and Validation
Compare the rewriteDryRun output with the original PR diff:

### Automated Comparison
* Extract the diff generated by rewriteDryRun
* Fetch the original PR diff using git or GitHub API
* Perform line-by-line comparison to identify:
  * Matching changes (success)
  * Missing changes (recipe gaps)
  * Extra changes (over-application)
  * Ordering differences (acceptable if semantically equivalent)

### Validation Metrics
Calculate and log:
* Coverage percentage: (matched changes / total PR changes) × 100
* Precision: (matched changes / total recipe changes) × 100
* False positives: Extra changes not in the original PR
* False negatives: PR changes not captured by the recipe

### Success Criteria
* 100% coverage with no extra changes: Full success
* >90% coverage with minor extras: Partial success, may need recipe tuning
* <90% coverage: Requires recipe revision or custom recipe development

## Error Handling and Edge Cases
* Handle cases where:
  * Gradle wrapper is missing or broken
  * Build fails before recipe execution
  * Recipe execution times out
  * Diff comparison tools are unavailable
  * PR has merge conflicts with main branch
* For failed validations:
  * Analyze why the recipe didn't match
  * Suggest recipe adjustments
  * Identify if manual intervention is required
  * Document patterns that OpenRewrite cannot handle

## Iteration Support
If validation fails:
* Provide specific guidance on recipe adjustments
* Support iterative refinement by:
  * Modifying recipe YAML
  * Adjusting recipe parameters
  * Adding preconditions or postconditions
* Re-run validation after adjustments
* Track iteration count and improvements in scratchpad

## Output Format
For each validated recipe, provide:
* Validation metrics and status
* Detailed comparison results
* Recommendations for improvements
* Next steps for deployment or refinement

## Success Criteria
* Accurate validation of recipe effectiveness
* Clear metrics showing coverage and precision
* Actionable recommendations for recipe improvements
* Well-documented validation results for decision making