# Validate Recipes Command

This command tests OpenRewrite recipes against PRs and validates their effectiveness. You're an experienced software engineer who is an expert in Java and refactoring.

## Scratchpad Setup
* Use `<yyyy-mm-dd-hh-MM>-validate-recipes.md` scratchpad file located in .scratchpad directory to log your actions. Use current date and time for the scratchpad name.
* Very first line of the scratchpad must be `Session ID: <id>`. Use `scripts/get-session-id.sh` command to retrieve session id.
* Before starting any action, log your intentions and reasons you decided to do that. After action is complete, log the results. If action fails, log the fact of the failure and your analysis of it.
* This scratchpad must contain a detailed log of what you've done, what issues you've encountered, commands you ran and your thought process. Only append, do not rewrite previous entries in the scratchpad.

## Prerequisites
* Recipe mapping should be completed (use `/map-recipes` command first)
* Repositories should be available in `.workspace/` directory
* Recipe recommendations should be documented in scratchpad

## Recipe YAML Generation
For each repository with mapped recipes:
* Create a recipe YAML file at `.workspace/<owner>/<repo>/rewrite.yml`
* Structure the recipe based on previous recommendations:
  ```yaml
  ---
  type: specs.openrewrite.org/v1beta/recipe
  name: com.example.PRRecipe<PR_NUMBER>
  displayName: Recipe for PR #<PR_NUMBER>
  description: Automated recipe to replicate changes from PR #<PR_NUMBER>
  recipeList:
    - [Primary recipe identified in previous phase]
    - [Supporting recipes as needed]
  ```
* Include any necessary recipe configurations and parameters
* Copy the same file to each repository root for testing
* Log the generated recipe structure to the scratchpad

## Gradle Init Script Generation
Create `rewrite.gradle` initscript for each repository:
* Analyze the root `build.gradle` or `build.gradle.kts` file to:
  * Identify existing OpenRewrite dependencies and versions
  * Determine the appropriate recipe dependencies needed
  * Check for any existing rewrite configurations to avoid conflicts

* Generate the initscript at `.workspace/<repo>/rewrite.gradle`:
  ```gradle
  initscript {
      repositories {
          mavenCentral()
      }
      dependencies { classpath("org.openrewrite:plugin:7.3.0") }
  }
  rootProject {
      plugins.apply(org.openrewrite.gradle.RewritePlugin)
      dependencies {
          rewrite platform('org.openrewrite.recipe:rewrite-recipe-bom:3.10.1')
          <dependencies>
      }
      rewrite {
          <activeRecipe>
          setExportDatatables(true)
      }
  }
  ```

* Populate the `<dependencies>` block with:
  * Existing rewrite dependencies from build.gradle
  * Additional dependencies required by the selected recipes

* Set `<activeRecipe>` to the generated recipe name from the YAML file

## Dry Run Execution
For each repository:
* Ensure you're on the main/master branch (not the PR branch)
* Execute the dry run command:
  ```bash
  ./gradlew rewriteDryRun --init-script rewrite.gradle
  ```
* Capture the full output including:
  * Recipe execution logs
  * Generated diff output
  * Any warnings or errors
  * Execution time and statistics

## Diff Analysis and Validation
Compare the rewriteDryRun output with the original PR diff:

### Automated Comparison
* Extract the diff generated by rewriteDryRun
* Fetch the original PR diff using git or GitHub API
* Perform line-by-line comparison to identify:
  * Matching changes (success)
  * Missing changes (recipe gaps)
  * Extra changes (over-application)
  * Ordering differences (acceptable if semantically equivalent)

### Validation Metrics
Calculate and log:
* Coverage percentage: (matched changes / total PR changes) × 100
* Precision: (matched changes / total recipe changes) × 100
* False positives: Extra changes not in the original PR
* False negatives: PR changes not captured by the recipe

### Success Criteria
* 100% coverage with no extra changes: Full success
* >90% coverage with minor extras: Partial success, may need recipe tuning
* <90% coverage: Requires recipe revision or custom recipe development

## Results Documentation
Create a validation report in the scratchpad:
```
Repository: <owner>/<repo>
PR: #<number>
Recipe: <name>
Validation Results:
  Coverage: <percentage>
  Precision: <percentage>
  Missing Changes: <list or none>
  Extra Changes: <list or none>
  Status: SUCCESS|PARTIAL|FAILED
  Recommendations: <next steps if not successful>
```

## Error Handling and Edge Cases
* Handle cases where:
  * Gradle wrapper is missing or broken
  * Build fails before recipe execution
  * Recipe execution times out
  * Diff comparison tools are unavailable
  * PR has merge conflicts with main branch
* For failed validations:
  * Analyze why the recipe didn't match
  * Suggest recipe adjustments
  * Identify if manual intervention is required
  * Document patterns that OpenRewrite cannot handle

## Iteration Support
If validation fails:
* Provide specific guidance on recipe adjustments
* Support iterative refinement by:
  * Modifying recipe YAML
  * Adjusting recipe parameters
  * Adding preconditions or postconditions
* Re-run validation after adjustments
* Track iteration count and improvements in scratchpad

## Output Format
For each validated recipe, provide:
* Validation metrics and status
* Detailed comparison results
* Recommendations for improvements
* Next steps for deployment or refinement

## Success Criteria
* Accurate validation of recipe effectiveness
* Clear metrics showing coverage and precision
* Actionable recommendations for recipe improvements
* Well-documented validation results for decision making